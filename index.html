<!DOCTYPE html>
<html>
  <head>
    <title>WatchTracking</title>
	<meta charset="utf-8"/>
    <script src="http://maps.google.com/maps/api/js?sensor=true"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.2/jquery.min.js"></script>

	 <link rel="stylesheet" type="text/css" href="css/button.css"/>

    <script type="text/javascript" charset="utf-8" src="phonegap.js"></script>
    <script type="text/javascript" charset="utf-8">
	var activada = false;
	var $_GET = {};
	if(document.location.toString().indexOf('?') !== -1) {
		var query = document.location
		               .toString()
		               .replace(/^.*?\?/, '')
		               .replace(/#.*$/, '')
		               .split('&');

		for(var i=0, l=query.length; i<l; i++) {
		   var aux = decodeURIComponent(query[i]).split('=');
		   $_GET[aux[0]] = aux[1];
		}
	}
	var telefono = $_GET['phone'];
	var contrasenia = $_GET['pass'];
    document.addEventListener("deviceready", onDeviceReady, false);
    function onDeviceReady() {
    }
    function alertDismissed() {
    }
    function createTable() {
        $.ajax({
            type: "POST",
            url: "http://watchthekids.esy.es/create_table.php",
            data: { tabla:  contrasenia}
            })
            .done(function( msg ) {
                alert("Esperando GPS");
                insertCoord();
            })             
            .fail(function(msg ) {
            });
    }    
    function onSuccess(pos) {
        var crd = pos.coords;
        $.ajax({
            type: "POST",
            url: "http://watchthekids.esy.es/insert_coord.php",
            data: { tabla: contrasenia, lat: crd.latitude, lng:  crd.longitude }
            })
            .done(function( msg ) {
                alert("envia coordenada");
				var aleatorio = Math.floor((Math.random() *1000)); 
				//location.href="sms//:"+String(telefono)+"?body=http://watchthekids.esy.es/maps.html?pass="+String(contrasenia)+ String(aleatorio);
            });
	
	}
    function GetCurrentPosition() {
        navigator.geolocation.getCurrentPosition(onSuccess);
    }

    function insertCoord() {
        changeButton();
        idinterval = setInterval(GetCurrentPosition, 60000);
    }
    
    function changeButton(){
		if(activada){
    		$('#button').removeClass("hide");
			$('#configurationButton').removeClass("hide");
    		$('#button2').addClass("hide");
			activada = false;
		}
		else{
			$('#button2').removeClass("hide");
			$('#configurationButton').addClass("hide");
    		$('#button').addClass("hide")
			activada = true;
		}
    }

    function desactivate () {
        clearInterval(idinterval);
		  changeButton();
    }
    </script>
  </head>
  <body>
	 <center>
		<form name="form1">
			<div id="button" onClick="createTable()" class="myButton buttonActivar"><p>Activar</p></div>
			<div id="button2" class="myButton2 buttonActivar hide" onclick="desactivate()"><p>Desactivar</p></div>
		</form>

		<form name="form2" action="configuracion.html" method="post">
			<input id="configurationButton" type="submit" class="myButton" value="ConfiguraciÃ³n"/>
		</form>
	 </center>
  </body>
</html>
